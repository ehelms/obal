---
- hosts: packages
  serial: 1
  gather_facts: no
  tasks:
    - name: 'Create package directory'
      file:
        state: directory
        path: "{{ inventory_dir }}/packages/{{ inventory_hostname }}"

    - name: 'Fetch gem'
      command: "gem fetch {{ gem_name }} --version {{ version }}"
      args:
        chdir: "{{ inventory_dir }}/packages/{{ inventory_hostname }}"

    - name: 'Run gem2rpm'
      shell: "gem2rpm -t {{ inventory_dir }}/{{ rubygem_spec_template }} {{ gem_name }}-{{ version }}.gem > {{ inventory_hostname }}.spec"
      args:
        chdir: "{{ inventory_dir }}/packages/{{ inventory_hostname }}"

    - name: 'Git annex add new file(s)'
      command: "git annex add {{ gem_name }}-{{ version }}.gem"
      args:
        chdir: "{{ inventory_dir }}/packages/{{ inventory_hostname }}"

    - name: 'Add new sources'
      command: "git add packages/{{ inventory_hostname }}/*.spec"
      args:
        chdir: "{{ inventory_dir }}"

    - name: 'Create git branch'
      command: "git checkout -b {{ gem_name }}-{{ version }}"
      args:
        chdir: "{{ inventory_dir }}"

    - name: 'Create git commit'
      command: "git commit -a -m 'Add {{ gem_name }} {{ version }}'"
      args:
        chdir: "{{ inventory_dir }}"
